FJ.define("widget.AutoComplete",["widget.Tooltip"],function(){var d,c,a=d=c=this.flareJ,b=this.jQuery;this.AutoCompleteJ=this.ACJ=d.AutoCompleteJ=d.ACJ=d.CJ.extend({init:function(e,g){var f=this;this.widthE=e.width();this._super(e,b.extend(true,{fjType:"ACJ",renderTo:"body",width:"auto",height:"auto",shiftWidth:4,shiftTop:e.height(),borderWidth:0,inputPName:"txtValue",delaySpeed:300,showSpeed:10,maxHeight:200,loadMode:"remote",data:[],dataLimit:100,showAllData:true,showOnFocus:true,onlyShowAllData:false,isOnlySelect:false,initLoadData:false,textField:"text",valueField:"value",actualTextField:"data-acj-text",actualValueField:"data-acj-value",textRule:"{0}",defaultText:null,defaultValue:null,itemAlign:null,autoTurn:false,scrollViewShift:0,colorParams:{},evts:{customUpdate:null}},g));this.input=e;this.input.attr("autocomplete","off");this.input.addClass("acj_input");this.initFn();return this},initFn:function(){var e=this;this._super();this.isFirstLoad=true;this.canHover=true;this.customUpdate=this.p.evts.customUpdate!=null;this.create();this.bindKeyUp();this.resetValue();this.needScrollView=c.isMobile&&!this.p.autoTurn;if(!this.customUpdate){if(this.p.showOnFocus){this.input.on("focus",function(f){if(!e.focusOnScroll){if(e.p.loadMode==="local"){if(!e.p.initLoadData||e.initLoaded){e.afterInput(true)}else{e.acjUl.html("<li></li>");e.display(1);e.fire("initLoadData")}}else{if(e.p.data&&e.p.data.length>0){e.display(1)}}}e.focusOnScroll=false})}}else{if(this.p.initLoadData){this.initLoadComplete(this.p.data)}if(this.needScrollView){this.input.on("focus",function(){e.scrollView()}).on("blur",function(){c.body.scrollTop=0})}}},create:function(){this._super();var f=this,g=this.customUpdate,e=this.p.width;this.divOut.addClass("acj").attr("id","ACJ_"+this.objId);if(e!=null&&e!=="auto"){this.widthE=e}this.acjUl=b("<ul></ul>").addClass("acj_ul");this.divOut.append(this.acjUl);if(!g){this.ttj=b(this.input).TTJ({renderTo:this.p.renderTo,showRendorBody:this.p.renderTo=="body"?false:true,imgLoadSrc:LMJ.loadImgSrc(10),showLoading:f.p.initLoadData?false:true,borderWidth:1,width:this.widthE+this.p.shiftWidth,height:"auto",hoverDirect:"bottom",shiftLeft:-1,shiftTop:this.p.shiftTop-3,hoverType:"click",hasShadow:true,onlyFirstLoad:true,loadSpeed:1,speed:1,showSpeed:this.p.showSpeed,isAcjClick:true,isRenderHF:false,autoTurn:this.p.autoTurn,zIndex:this.p.zIndex,closeCheckScroll:true,fnHtml:function(h){this.currentObj=f.input;this.bodyIn.css({overflowY:"auto",overflowX:"hidden"}).on("scroll",function(){c.lazyDo(function(){this.focusOnScroll=true;this.input.trigger("focus")},50,"acj_inputFocus",f)});this.divOut.addClass("acj_ttj");f.divOut.show();return f.divOut},colorParams:{bgColorBody:"transparent"},evts:{afterBodyLoad2:function(i,h){if(f.isFirstLoad){f.isFirstLoad=false;f.countHeight();f.countPosition(this)}if(f.p.loadMode=="local"&&f.p.initLoadData&&!f.initLoaded){this.p.showLoading=true;f.showLoading(true)}if(f.needScrollView){c.lazyDo(function(){f.scrollView()},300)}},afterShowFn:function(i,h){if(!f.isFirstLoad){f.countHeight();f.countPosition(this)}},afterCloseClick:function(i,h){if(f.p.loadMode=="local"&&f.p.isOnlySelect&&f.runCloseClick){f.runCloseClick=false;if(b.trim(f.input.val())!=""){f.input.val(f.input.attr(f.p.actualTextField))}else{f.resetValue()}}},afterClose:function(){if(f.needScrollView){c.body.scrollTop=0}}}})}return this},show:function(){var e=this.input.offset();this.divOut.css({width:this.input.width()+this.p.shiftWidth,left:e.left,top:e.top+this.input.height()+this.p.shiftTop});this.divOut.show()},bindKeyUp:function(){var e=this;this.input.on(c.isMobile?"input":"keyup",function(f){e.KeyUpFn(f)})},KeyUpFn:function(j){var i=this,h=this.customUpdate;switch(d.Evt.fix(j).key){case 13:if(!h){var k=this.acjUl.find("li.acj_selectedItem");if(k.length>0){k.trigger("click")}}break;case 27:if(!h){this.display(0);this.runCloseClick=true}break;case 38:if(!h&&!this.divOut.is(":hidden")){var f=this.acjUl.find("li");var l=this.acjUl.find("li.acj_selectedItem");if(l.length>0){var n=l.removeClass("acj_selectedItem").prev();n.addClass("acj_selectedItem");if(n.length>0){var m=n.position().top+this.ttj.bodyIn.scrollTop();if(m<this.ttj.divOut.height()+this.ttj.bodyIn.scrollTop()-20){this.ttj.bodyIn.scrollTop(m)}}}else{f.eq(f.length-1).addClass("acj_selectedItem");this.ttj.bodyIn.scrollTop(this.ttj.bodyIn[0].scrollHeight)}if(c.isFF||c.isWebkit){this.input.textPositionJ(this.input.val().length)}this.canHover=false}break;case 40:if(!h&&!this.divOut.is(":hidden")){var f=this.acjUl.find("li");var l=this.acjUl.find("li.acj_selectedItem");if(l.length>0){var g=l.removeClass("acj_selectedItem").next();g.addClass("acj_selectedItem");if(g.length>0){var m=g.position().top+this.ttj.bodyIn.scrollTop();if(m>this.ttj.divOut.height()+this.ttj.bodyIn.scrollTop()-20){this.ttj.bodyIn.scrollTop(m)}}}else{f.eq(0).addClass("acj_selectedItem");this.ttj.bodyIn.scrollTop(0)}this.canHover=false}break;default:c.lazyDo(function(){if(!h&&this.ttj.p.hasShadow&&d.isIEgt9){this.ttj.divOut.css("box-shadow","0px 0px 0px "+this.ttj.p.colorParams.shadow)}var e=this.input.val();if(e!=this.valL){this.afterInput()}this.valL=e},this.p.delaySpeed,"acj_delay",this);break}c.lazyDo(function(){this.canHover=true},200,"acj_canHover",this)},afterInput:function(g){var j=this;var n=this.input.val();if(this.p.loadMode==="local"){var m=[],e=null,k=function(){if(j.p.showAllData){m=j.p.data;e=true}};if(!g){if(n.length!=0&&!this.p.onlyShowAllData){for(var h=0,f=this.p.data.length;h<f;h++){if((this.p.data[h][this.p.textField]+"").toLowerCase().indexOf(n.toLowerCase())!=-1){m[m.length]=this.p.data[h]}}e=false;this.isAllLastTime=e}else{k()}}else{k()}if(this.isAllLastTime==null||!this.isAllLastTime||m.length==0){this.update(m)}else{this.display(1);this.runCloseClick=true}this.isAllLastTime=e}this.fire("afterInput",{input:n})},update:function(j,h,f){var n=this,g=j?j.length:0,o=this.p.dataLimit;if(h||this.p.loadMode==="remote"){this.p.data=j}if(o&&g>o){j=j.slice(0,o)}if(!this.customUpdate){if(g>0){var p=false;this.clearItems();for(var k=0,e=j.length;k<e;k++){(function(x){var u=n.p.textField,i=n.p.valueField,s=n.p.textRule,m=x[u],l=x[i];s=s.replace(/\{0\}/g,m);s=s.replace(/\{1\}/g,l);var w=b("<li class='acj-item' "+(n.p.itemAlign?"style='text-align:"+n.p.itemAlign+";'":"")+"><span class='acj-item-txt'>"+s+"</span></li>").bind("click",function(v){v.stopPropagation();var t=x[u],y=x[i];n.input.val(t);if(t!=null){n.input.attr(n.p.actualTextField,t)}else{n.input.attr(n.p.actualTextField,"")}if(y!=null){n.input.attr(n.p.actualValueField,y)}else{n.input.attr(n.p.actualValueField,"")}n.display(0);n.runCloseClick=false;n.fire("afterSelect",{txt:t,val:y});n.input.blur()});w.hover(function(){if(n.canHover){n.acjUl.find("li.acj_selectedItem").removeClass("acj_selectedItem");b(this).addClass("acj_selectedItem")}},function(){});n.acjUl.append(w);if(f!=null){if(p!=null){p=true}if(f===l){w.click();p=null}}})(j[k])}if(p){n.acjUl.children("li:eq(0)").click()}if(!h){this.display(1);if(c.isIE7){var q=this.ttj.bodyIn,r=q.width();q.width(r+1);setTimeout(function(){q.width(r)},200)}}}else{this.display(0)}}else{this.fire("customUpdate",{data:j})}n.runCloseClick=true},clearItems:function(){this.acjUl.empty()},resetValue:function(){if(this.p.defaultText!=null){this.input.val(this.p.defaultText);this.input.attr(this.p.actualTextField,this.p.defaultText)}if(this.p.defaultValue!=null){this.input.attr(this.p.actualValueField,this.p.defaultValue)}},showLoading:function(e){if(this.customUpdate){return}this.ttj.showLoad(e)},display:function(e){if(this.customUpdate){return}if(e===true||e===1||e==null){this.ttj.setVisible(true)}else{this.ttj.setVisible(false)}},initLoadComplete:function(e){this.p.data=e;if(e.length==0){this.clearItems()}this.initLoaded=true;this.isAllLastTime=null;this.showLoading(false);this.p.showLoading=false;this.afterInput(true)},countHeight:function(){var j=this.divOut.height(),f=this.p.maxHeight,i=this.ttj,g=i.pjBody,e=i.bodyIn,k=i.divOut;if(j<=f){g.css("height","auto");e.css("height","auto")}else{g.css("height",f);e.css("height",f)}},countPosition:function(f){var g=this.input.offset(),i=0,h=0,e=this.p.autoTurn;if(e){h=f.divOut.height()}if(e&&(g.top-b("html").scrollTop())>document.documentElement.clientHeight-h-20){i=g.top-h-f.p.shiftTop+9}else{i=g.top+this.input[0].offsetHeight/2+f.p.shiftTop}f.divOut.css("top",i)},scrollView:function(){this.input[0].scrollIntoView();var e=this.p.scrollViewShift;if(e){c.lazyDo(function(){c.body.scrollTop-=e})}}});b.fn.extend({AutoCompleteJ:function(e){if(this&&this.length>0){return new d.AutoCompleteJ(this,c.ACJ_commonConfig?b.extend(true,c.clone(c.ACJ_commonConfig),e):e)}},ACJ:function(e){return b(this).AutoCompleteJ(e)}})});